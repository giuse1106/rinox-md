import { GoogleSearch } from 'google-search-results';

const SERPAPI_KEY = '45d6ca5ebff318d0a630e68fb111d341e43d9271c64476693bfbef85585cc5de'; // Inserisci la tua API Key di SerpApi
const search = new GoogleSearch(SERPAPI_KEY);

const tutorialCucina = {
    'carbonara': [
        'ü•ö 2 uova',
        'ü•ì 100g guanciale',
        'üßÄ 50g pecorino romano',
        'üåø Pepe nero',
        'üçù 200g spaghetti'
    ],
    'tiramisu': [
        'üç™ 300g savoiardi',
        '‚òï 250ml caff√®',
        'üßÄ 250g mascarpone',
        'ü•ö 2 uova',
        'üç´ Cacao in polvere',
        'üç¨ Zucchero'
    ],
    'margherita': [
        'üçï 1 base per pizza',
        'üçÖ 200g passata di pomodoro',
        'üßÄ 150g mozzarella',
        'üåø Basilico',
        'üßÇ Sale e olio d‚Äôoliva'
    ]
};

// Funzione per cercare un tutorial su YouTube usando SerpApi
const cercaVideoYoutube = async (query) => {
    return new Promise((resolve, reject) => {
        search.json({ q: `${query} ricetta tutorial`, engine: 'youtube' }, (data) => {
            if (data.video_results && data.video_results.length > 0) {
                resolve(data.video_results[0].link);
            } else {
                reject('Nessun video trovato.');
            }
        });
    });
};

// Definizione del comando handler
const handler = async (m, { conn, text, isGroup }) => {
    try {
        if (!isGroup) {
            return conn.reply(m.chat, '‚ùå Questo comando pu√≤ essere usato solo nei gruppi!', m);
        }

        if (!text?.trim()) {
            return conn.reply(m.chat, '‚ùå Devi specificare un piatto! Esempio: *.cucina carbonara*', m);
        }

        const nomePiatto = text.trim().toLowerCase();

        if (!tutorialCucina[nomePiatto]) {
            return conn.reply(m.chat, `‚ùå Ricetta non trovata! Prova con: *${Object.keys(tutorialCucina).join(', ')}*`, m);
        }

        const ingredienti = tutorialCucina[nomePiatto].join('\n‚û§ ');

        // Cerca il video tutorial su YouTube usando SerpApi
        let videoLink = 'üé• Nessun video trovato.';
        try {
            videoLink = await cercaVideoYoutube(nomePiatto);
        } catch (error) {
            console.error('Errore nella ricerca video:', error);
        }

        const messaggio = `üçΩÔ∏è *Tutorial per ${nomePiatto}*\n\nüìú *Ingredienti:*\n‚û§ ${ingredienti}\n\n${videoLink}`;
        await conn.reply(m.chat, messaggio, m);
    } catch (error) {
        console.error('[ERROR] Errore durante il tutorial di cucina:', error);
        await conn.reply(m.chat, '‚ùå Errore durante il tutorial di cucina!', m);
    }
};

// Configura il comando per l'handler (solo gruppi)
handler.command = /^\.cucina$/i; // Il comando riconosce ".cucina"
handler.group = true; // Pu√≤ essere usato solo nei gruppi
handler.private = false; // Disattivato nelle chat private

export default handler;